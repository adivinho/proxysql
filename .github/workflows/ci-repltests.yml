name: CI-repltests

on:
  workflow_dispatch:
  workflow_call:

#concurrency:
#  group: ${{ github.workflow }}-${{ github.ref_name }}
#  cancel-in-progress: true

jobs:
  build-n-test:
    runs-on: ubuntu-22.04
    steps:
    
    - name: Install dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y sysbench gettext
      
    - name: Checkout proxysql
      uses: actions/checkout@v3
      with:
        repository: 'sysown/proxysql'
#        ref: 'v2.x'
        ref: ${{ github.head_ref }}
        fetch-depth: 0
        path: 'proxysql'
        
    - name: Checkout jenkins_build_scripts
      uses: actions/checkout@v3
      with:
        repository: 'proxysql/jenkins-build-scripts'
        ref: 'proxysql_repl_tests'
        fetch-depth: 0
        path: 'jenkins-build-scripts'
        token: ${{ secrets.GH_TOKEN }}
        
    - name: Set GIT_VERSION
      run: |
        cd proxysql/
        git fetch --tags --force
        echo "GIT_VERSION=$(git describe --long --abbrev=7)" >> $GITHUB_ENV

    - name: Build
      run: |
        cd proxysql/
        make ubuntu22-dbg
        
    - name: Docker-hoster
      run: |
        cd jenkins-build-scripts/infra-docker-hoster
        docker-compose up -d
        
    - name: Replication-tests
      run: |
        set +e
        
        cd jenkins-build-scripts
        sed -i "s|#!/usr/bin/bash|#!/usr/bin/bash +e|" proxysql_repl_tests/bin/debezium-check.bash
        sed -i "s|#!/usr/bin/bash|#!/usr/bin/bash +e|" proxysql_repl_tests/exec_repl_test.sh
        sed -i "s|JENKINS_SCRIPTS_PATH=.*|JENKINS_SCRIPTS_PATH=${{ github.workspace }}/jenkins-build-scripts|" env.sh
        sed -i "s|WORKSPACE=.*|WORKSPACE=${{ github.workspace }}/proxysql|" env.sh
        
        cd proxysql_repl_tests
        #./exec_repl_test.sh 5.7 no-ssl debezium
        RCS=0
        for N in {1..5}; do
          ./exec_all_repl_tests.sh
          RC=$?
          RCS=$(( $RCS + $RC ))
        done
        
        #./docker-compose-destroy.bash
        sudo chmod -R 777 ${{ github.workspace }}/*
        exit $RCS
        
    - name: Archive artifacts
      if: ${{ failure() }}
      uses: actions/upload-artifact@v3
      with:
        name: ${{ github.workflow }}-${{ github.sha }}-run#${{ github.run_number }}
        path: |
          proxysql/ci_*_logs/
          proxysql/src/
          
          
